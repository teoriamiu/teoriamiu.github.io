<!DOCTYPE html>
<html lang="es" class="dark">

<head>
<title>Calculadora Nutricional</title>
  <meta name="description" content="Calculadora Nutricional. Calcula macros, micros, compuestos bioactivos. Perfiles, √≠ndices, funciones del sistema completo del cuepor humano y de los alimentos. Vdr personalizable.">

  <!-- ‚úÖ Etiqueta can√≥nica correcta -->
  <link rel="canonical" href="https://calculadoranutricional.com/">

  <link rel="icon" href="https://i.etsystatic.com/41732322/r/il/a6ee89/5914825593/il_340x270.5914825593_bpi8.jpg">
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-WQBSBXCBZG"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-WQBSBXCBZG');
</script>

<meta charset="utf-8" />
<meta content="IE=edge" http-equiv="X-UA-Compatible" />
<meta content="width=device-width, initial-scale=1" name="viewport">
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css" rel="stylesheet" />
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          animation: {
            fadeInUp: 'fadeInUp 0.8s ease-out both',
          },
          keyframes: {
            fadeInUp: {
              '0%': { opacity: 0, transform: 'translateY(20px)' },
              '100%': { opacity: 1, transform: 'translateY(0)' },
            },
          }
        }
      }
    };
  </script>
<style>
  *,
*::before,
*::after {
  box-sizing: border-box;
}

.seccion-comida select {
  cursor: pointer;
  text-align: center;
  font-weight: bold;
  width: 50%;
  margin: 0rem 0;
  padding: 2px 2px;
  font-size: 12px;
  border-radius: 0.5rem;
  background: transparent;
  appearance: none;
  display: block;
  margin: 0 auto;
  display: flex;
  justify-content: center;
  align-items: center;
}

.btn-grafica,
.btn-editor,
.btn-toggle-nutrientes,
.btn-total {
  width: 100%;
  padding: 8px 12px;
  font-size: 12px;
  border-radius: 0.5rem;
  background: white;
  transition: all 0.2s ease;
  cursor: pointer;
  text-align: center;
  font-weight: bold;
  margin-top: 0.1px;
  margin-bottom: 1px;
}

.select-editor {
  width: 100%;
  box-sizing: border-box;
  padding: 0 8px;
  font-size: 0.775rem;
  border: none;
  border-radius: 0;
  background: none;
  appearance: none;
  -webkit-appearance: none;
  -moz-appearance: none;
  color: inherit;
  font-family: inherit;
  text-align: center;
}

select:focus,
.select-unidad:focus {
  outline: none;
  box-shadow: none;
  border: none;
}

section {
  margin: 12px;
  padding: 0.7rem;
  border-radius: 12px;
  background: transparent;
  box-shadow: 0 0 7px rgba(0, 0, 0, 0.12);
  transition: box-shadow 0.3s ease, transform 0.3s ease;
  
}

section:hover {
  box-shadow: 0 0 14px rgba(0, 0, 0, 0.19);
  transform: translateY(-2px);
}

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.tabla {
  width: 100%;
  font-size: 0.775rem;
  background: transparent;
  border-radius: 0.5rem;
  border-collapse: separate;
  border-spacing: 0;
  overflow: hidden;
  margin-top: 0.1px;
  margin-bottom: 1px;
  table-layout: fixed; /* <-- Esto fuerza que respete los widths definidos */
}

.tabla thead {
  background: #f0f0f0;
  border-bottom: 1px solid #ccc;
  border-spacing: 0;
}

.tabla th,
.tabla td {
  padding: 0;
  background: transparent;
  color: #333;
  vertical-align: middle;
  border: 1px solid #ddd;
  border-spacing: 0;
  border-radius: 0.5rem;
  word-wrap: break-word;
  white-space: normal;
  overflow-wrap: break-word;
}

.tabla th:nth-child(1),
.tabla td:nth-child(1) {
  width: 40%;
  text-align: left;
  padding: 5px;
}

.tabla th:nth-child(2),
.tabla td:nth-child(2),
.tabla th:nth-child(3),
.tabla td:nth-child(3) {
  width: 20%;
  text-align: center;
}

.tabla th:nth-child(4),
.tabla td:nth-child(4) {
  width: 20%;
  text-align: center;
}

canvas {
  width: 100%;
  max-height: 300px;
  margin-top: 10px;
  background: transparent;
}

/* Mostrar placeholder en div contenteditable cuando est√° vac√≠o */
[contenteditable][placeholder]:empty::before {
  content: attr(placeholder);
  color: #9ca3af;         /* Color similar a text-gray-400 */
  pointer-events: none;   /* El placeholder no debe interferir con la edici√≥n */
  opacity: 0.7;
  font-size: 0.775rem;
}

[contenteditable] {
  min-height: 1.5em;
  outline: none;
  box-shadow: none;
  -webkit-tap-highlight-color: transparent;
  width: 100%;
margin: 0rem 0;
padding: 8px 12px;
font-size: 12px;
border-radius: 0.5rem;
background: transparent;
transition: all 0.2s ease;
}

/* Estilos en estado focus para que no muestre efectos visuales */
[contenteditable]:focus {
  outline: none;
  box-shadow: none;
  -webkit-tap-highlight-color: transparent;
  box-shadow: none !important;
  font-size: 0.775rem;
}

[contenteditable].input-editor {
  width: 100%;
  box-sizing: border-box;
  padding: 0 8px;
  font-size: 0.775rem;
  border: none;
  border-radius: 0;
  background: none;
  appearance: none;
  -webkit-appearance: none;
  -moz-appearance: none;
  color: inherit;
  font-family: inherit;
  text-align: center;
}

.input-editor:empty::before {
  content: "0";
  color: #aaa;
  pointer-events: none;
}
  </style>
</meta></head>
<body>
  
  
<!-- Contenedor fijo con t√≠tulo y bot√≥n alineados -->
<div class="fixed top-0 left-0 w-full z-50 flex items-center justify-between px-4 py-2 bg-white shadow-md">
  <!-- T√≠tulo centrado -->
  <h1 class="font-bold drop-shadow text-center m-0 flex-1" style="font-size: 16px;">
    Calculadora Nutricional
  </h1>
  
<button onclick="abrirVDR()" class="fixed right-2 z-50  font-semibold" style="font-size: 0.775rem;">
  VDR %
</button>
</div>

<!-- Contenido principal con espacio arriba -->
<div style="padding-top: 36px;">
  <!-- Todo tu contenido va ac√° -->
</div>

<!-- Panel VDR pantalla completa -->
<div id="panel-vdr" class="fixed inset-0 bg-white text-black z-50 hidden flex flex-col">
<div class="flex items-center p-1 border-b border-gray-300">
  <!-- Bot√≥n de flecha al estilo ChatGPT -->
  <button onclick="cerrarVDR()" title="Cerrar"
      class="mr-3 text-gray-600 hover:text-black p-1 rounded-full hover:bg-gray-200 transition">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none"
        viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
      </svg>
    </button>

  <!-- T√≠tulo -->
  <h2 class="font-bold" style="font-size: 16px;">Personalizar VDR</h2>
</div>
  <div id="formulario-vdr" class="overflow-y-scroll p-2 flex-1"></div>
<!-- Este bot√≥n va directamente dentro del panel-vdr, pero fuera del scroll -->
<button id="btn-guardar-vdr"
  onclick="guardarVdr()"
  style="
    display: none;
    font-weight: bold;
    font-size: 12px;
    position: fixed;
    left: 50%;
    transform: translateX(-50%);
    bottom: 16px;
    z-index: 100;
    padding: 10px 16px;
    background-color: #4caf50;
    color: white;
    border: none;
    border-radius: 8px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    touch-action: none; /* ‚¨ÖÔ∏è aqu√≠ */
  ">
  Guardar VDR
</button>
</div>
  
  <div id="contenedor-comidas"></div>
  
  <section class="seccion-total hidden" id="seccion-total-header">
    <h2 style="text-align: center; font-weight: bold;">Total</h2>
    <button class="btn-total" onclick="toggleSeccion('total')">Mostrar tabla y gr√°fico</button>
  </section>
  <div class="hidden" id="seccion-total">
<div id="contenido-perfiles"></div>
  <canvas id="grafico-total"></canvas>
  <section>
    <table class="tabla">
      <thead>
        <tr>
          <th>Nutriente</th>
          <th>Cantidad</th>
          <th>Unidad</th>
          <th>VDR%</th>
        </tr>
      </thead>
      <tbody id="tabla-total"></tbody>
    </table>
<button class="btn-editor" onclick="compartirResultados('total')">Compartir resultados</button>
    </section>
  </div>
<script>

document.addEventListener("DOMContentLoaded", () => {
  generarFormularioVDR(); // Se genera una vez
  cerrarVDR(); // Asegura que empiece oculto
});

function ajustarPosicionBotonGuardar() {
  const btn = document.getElementById("btn-guardar-vdr");
  if (!btn) return;
  
  const activo = document.activeElement;
  const esEditable = activo?.isContentEditable;
  
  if (!esEditable) {
    btn.style.display = "none";
    return;
  }
  
  btn.style.display = "block";
  
  const offset = 8;
  let bottom = offset;
  
  if (window.visualViewport) {
    const alturaTeclado = window.innerHeight - window.visualViewport.height;
    if (alturaTeclado > 100) {
      bottom = alturaTeclado + offset;
    }
  }
  
  btn.style.bottom = `${bottom}px`;
}



// Detecta cambios de foco y teclado
window.visualViewport?.addEventListener("resize", ajustarPosicionBotonGuardar);
window.addEventListener("scroll", ajustarPosicionBotonGuardar);
document.addEventListener("focusout", () => {
  setTimeout(ajustarPosicionBotonGuardar, 100); // con delay por cierre de teclado
});



function abrirVDR() {
  const panel = document.getElementById("panel-vdr");
  if (panel) {
    panel.classList.remove("hidden");
  }
  document.getElementById("boton-vdr-flotante")?.classList.add("hidden");
  ajustarPosicionBotonGuardar();
}

function cerrarVDR() {
  const panel = document.getElementById("panel-vdr");
  if (panel) panel.classList.add("hidden");
  document.getElementById("boton-vdr-flotante")?.classList.remove("hidden");
}


function generarFormularioVDR() {
  if (formularioVDRInicializado) return;
  formularioVDRInicializado = true;
  
  const contenedor = document.getElementById("formulario-vdr");
  if (!contenedor) return;
  
  const categorias = {};
  nutrientesPlanos.forEach(n => {
    const cat = n.categoria || "Otros";
    (categorias[cat] ??= []).push(n);
  });
  
  let html = `<table class="tabla">
    <thead>
      <tr>
        <th>Nutriente</th>
        <th>Cantidad</th>
        <th>Unidad</th>
        <th>VDR%</th>
      </tr>
    </thead>
    <tbody>`;
  
  for (const [categoria, nutrientes] of Object.entries(categorias)) {
    html += `
      <tr>
        <td colspan="4" style="font-weight:bold; background:#f8f8f8; text-align:center;">${categoria}</td>
      </tr>`;
    for (const n of nutrientes) {
      const valorVDR = vdr[n.nombre] ?? "";
      html += `
        <tr>
          <td style="text-align:left;">${n.nombre}</td>
          <td style="text-align:center;">
<div contenteditable="true"
     data-nutriente="${n.nombre}"
     class="input-editor placeholder flex items-center justify-center bg-white border border-gray-300"
     style="min-width: 60px;"></div>


          </td>
          <td style="text-align:center;">${n.unidad || ""}</td>
          <td style="text-align:center; color: green;">100%</td>
        </tr>`;
    }
  }
  
  html += `</tbody></table>`;
  contenedor.innerHTML = html;
  
  // Listeners para guardar al salir del campo
  document.querySelectorAll("[data-nutriente]").forEach(div => {
    div.addEventListener("blur", () => {
      const nombre = div.getAttribute("data-nutriente");
      const valor = parseFloat(div.textContent.replace(",", "."));
      if (!isNaN(valor)) {
        vdr[nombre] = valor;
        Calculadora(); // Recalcula valores en tiempo real
      }
    });
  });
  
  Calculadora(); // Refresca una vez al terminar
}


function guardarVdr() {
  // 1. Guardar nuevos VDRs desde contenteditables
  const editores = document.querySelectorAll('#formulario-vdr .input-editor[data-nutriente]');
  editores.forEach(div => {
    const nombre = div.dataset.nutriente;
    const texto = div.innerText.replace(",", ".").trim();
    const valor = parseFloat(texto);
    if (!isNaN(valor)) {
      vdr[nombre] = valor;
    }
  });
  
  // 2. Mostrar toast y cerrar panel
  mostrarToastVdr();
  cerrarVDR();
}

function mostrarToastVdr() {
  const id = "toast-vdr-overlay";
  if (document.getElementById(id)) return;
  
  const overlay = document.createElement("div");
  overlay.id = id;
  
  // üî• Nuevo estilo: ocupa todo el contenido, aunque se scrollee
  overlay.style.cssText = `
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: ${Math.max(document.body.scrollHeight, document.documentElement.scrollHeight)}px;
    background-color: rgba(0, 0, 0, 0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
  `;
  
  const toast = document.createElement("div");
  toast.textContent = "‚úÖ VDR guardado y actualizado";
  toast.style.cssText = `
    background: #4caf50;
    color: white;
    padding: 12px 20px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 500;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    text-align: center;
    max-width: 90%;
    opacity: 0;
    transform: translateY(20px);
    transition: opacity 0.3s ease, transform 0.3s ease;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(1);
  `;
  
  overlay.appendChild(toast);
  document.body.appendChild(overlay);
  
  requestAnimationFrame(() => {
    overlay.style.opacity = "1";
    overlay.style.pointerEvents = "auto";
    toast.style.opacity = "1";
  });
  
  setTimeout(() => {
    toast.style.opacity = "0";
    overlay.style.opacity = "0";
    overlay.style.pointerEvents = "none";
    
    setTimeout(() => {
      overlay.remove();
    }, 300);
  }, 1000);
}
</script>
<script>


const comidas = ["Desayuno", "Almuerzo", "Merienda", "Cena"];

const categorias = ["Frutas", "Verduras", "Cereales", "L√°cteos", "Carnes"];

const nutrientes = {
  "Alfanutrientes": [
    { nombre: "Water", unidad: "g" },
    { nombre: "Solids, insoluble", unidad: "mg" },
    { nombre: "Solids, soluble", unidad: "mg" },
    { nombre: "Solid, total", unidad: "mg" },
  ],
  "Macronutrientes": [
    { nombre: "Energ√≠a", unidad: "kcal" },
    { nombre: "Prote√≠nas", unidad: "g" },
    { nombre: "Carbohidratos", unidad: "g" },
    { nombre: "Nitrogen", unidad: "mg" },
    { nombre: "Grasas totales", unidad: "g" },
    { nombre: "Ash", unidad: "g" },
  ],
  "Componentes especificos de la Fibra": [
    { nombre: "GOS", unidad: "mg" },
    { nombre: "Fructooligosac√°ridos", unidad: "mg" },
    { nombre: "Beta-fructanos", unidad: "mg" },
    { nombre: "Lignin", unidad: "mg" },
    { nombre: "Beta-glucan", unidad: "mg" },
    { nombre: "Resistant starch", unidad: "g" },
    { nombre: "Pectin", unidad: "mg" },
    { nombre: "Cellulose", unidad: "mg" },
    { nombre: "Hemicellulose", unidad: "mg" },
    { nombre: "Pentosan", unidad: "mg" },
  ],
  "Fibra soluble": [
    { nombre: "Fiber, soluble", unidad: "g" },
    { nombre: "Soluble dietary fiber (SDFP+SDFS)", unidad: "g" },
    { nombre: "Soluble dietary fiber (SDFP)", unidad: "g" },
    { nombre: "Soluble dietary fiber (SDFS)", unidad: "g" },
    { nombre: "Low Molecular Weight Dietary Fiber (LMWDF)", unidad: "g" },
  ],
  "Fibras insolubles": [
    { nombre: "Fiber, insoluble", unidad: "g" },
    { nombre: "Insoluble dietary fiber (IDF)", unidad: "g" },
    { nombre: "High Molecular Weight Dietary Fiber (HMWDF)", unidad: "g" },
  ],
  "Fibra total": [
    { nombre: "Total dietary fiber (AOAC 2011.25)", unidad: "g" },
    { nombre: "Fiber, total dietary", unidad: "g" },
  ],
  "Polialcoholes": [
    { nombre: "Xylitol", unidad: "mg" },
    { nombre: "Mannitol", unidad: "mg" },
    { nombre: "Sorbitol", unidad: "mg" },
    { nombre: "Total sugar alcohols", unidad: "g" },
  ],
  "Monosac√°ridos": [
    { nombre: "Glucose", unidad: "mg" },
    { nombre: "Fructose", unidad: "mg" },
    { nombre: "Galactose", unidad: "mg" },
    { nombre: "Mannose", unidad: "mg" },
    { nombre: "Ribose", unidad: "mg" },
    { nombre: "Xylose", unidad: "mg" },
    { nombre: "Arabinose", unidad: "mg" },
    { nombre: "Triose", unidad: "mg" },
    { nombre: "Tetrose", unidad: "mg" },
    { nombre: "Pentoses", unidad: "mg" },
  ],
  "Disac√°ridos": [
    { nombre: "Sucrose", unidad: "mg" },
    { nombre: "Lactose", unidad: "mg" },
    { nombre: "Maltose", unidad: "mg" },
  ],
  "Oligosacaridos": [
    { nombre: "Verbascose", unidad: "mg" },
    { nombre: "Inulin", unidad: "mg" },
    { nombre: "Raffinose", unidad: "mg" },
    { nombre: "Stachyose", unidad: "mg" },
    { nombre: "Oligosaccharides", unidad: "mg" },
  ],
  "Polisacaridos": [
    { nombre: "Starch", unidad: "g" },
    { nombre: "Amylose", unidad: "mg" },
    { nombre: "Amylopectin", unidad: "mg" },
    { nombre: "Nonstarch polysaccharides", unidad: "g" },
    { nombre: "Glycogen", unidad: "mg" },
    { nombre: "Other Saccharides", unidad: "mg" },
  ],
  "Categor√≠as funcionales": [
    { nombre: "Reducing sugars", unidad: "g" },
    { nombre: "Total Sugars", unidad: "g" },
  ],
  "√Åcidos Grasos Saturados (SFA)": [
    { nombre: "SFA 4:0", unidad: "mg" },
    { nombre: "SFA 5:0", unidad: "mg" },
    { nombre: "SFA 6:0", unidad: "mg" },
    { nombre: "SFA 7:0", unidad: "mg" },
    { nombre: "SFA 8:0", unidad: "mg" },
    { nombre: "SFA 9:0", unidad: "mg" },
    { nombre: "SFA 10:0", unidad: "mg" },
    { nombre: "SFA 11:0", unidad: "mg" },
    { nombre: "SFA 12:0", unidad: "mg" },
    { nombre: "SFA 13:0", unidad: "mg" },
    { nombre: "SFA 14:0", unidad: "mg" },
    { nombre: "SFA 15:0", unidad: "mg" },
    { nombre: "SFA 16:0", unidad: "mg" },
    { nombre: "SFA 17:0", unidad: "mg" },
    { nombre: "SFA 18:0", unidad: "mg" },
    { nombre: "SFA 19:0", unidad: "mg" },
    { nombre: "SFA 20:0", unidad: "mg" },
    { nombre: "SFA 21:0", unidad: "mg" },
    { nombre: "SFA 22:0", unidad: "mg" },
    { nombre: "SFA 23:0", unidad: "mg" },
    { nombre: "SFA 24:0", unidad: "mg" },
    { nombre: "Fatty acids, total saturated", unidad: "g" },
    { nombre: "Fatty acids, total saturated, NLEA", unidad: "g" },
    { nombre: "Fatty acids, saturated, other", unidad: "g" },
  ],
  "√Åcidos Grasos Monoinsaturados (MUFA)": [
    { nombre: "MUFA 12:1", unidad: "mg" },
    { nombre: "MUFA 14:1", unidad: "mg" },
    { nombre: "MUFA 14:1 c", unidad: "mg" },
    { nombre: "MUFA 15:1", unidad: "mg" },
    { nombre: "MUFA 16:1", unidad: "mg" },
    { nombre: "MUFA 16:1 c", unidad: "mg" },
    { nombre: "MUFA 17:1", unidad: "mg" },
    { nombre: "MUFA 17:1 c", unidad: "mg" },
    { nombre: "MUFA 18:1", unidad: "mg" },
    { nombre: "MUFA 18:1 c", unidad: "mg" },
    { nombre: "MUFA 18:1-11 t (18:1t n-7)", unidad: "mg" },
    { nombre: "MUFA 18:1-11 c (18:1c n-7)", unidad: "mg" },
    { nombre: "MUFA 20:1", unidad: "mg" },
    { nombre: "MUFA 20:1 c", unidad: "mg" },
    { nombre: "MUFA 22:1", unidad: "mg" },
    { nombre: "MUFA 22:1 c", unidad: "mg" },
    { nombre: "MUFA 22:1 n-9", unidad: "mg" },
    { nombre: "MUFA 22:1 n-11", unidad: "mg" },
    { nombre: "MUFA 24:1 c", unidad: "mg" },
    { nombre: "Fatty acids, total monounsaturated", unidad: "g" },
  ],
  "√Åcidos Grasos Poliinsaturados (PUFA)": [
    { nombre: "PUFA 16:2", unidad: "mg" },
    { nombre: "PUFA 18:2", unidad: "mg" },
    { nombre: "PUFA 18:2 i", unidad: "mg" },
    { nombre: "PUFA 18:2 t,c", unidad: "mg" },
    { nombre: "PUFA 18:2 c,t", unidad: "mg" },
    { nombre: "PUFA 18:2 t,t", unidad: "mg" },
    { nombre: "PUFA 18:2 CLAs", unidad: "mg" },
    { nombre: "PUFA 18:2 n-6 c,c", unidad: "mg" },
    { nombre: "PUFA 18:2 c", unidad: "mg" },
    { nombre: "PUFA 18:3", unidad: "mg" },
    { nombre: "PUFA 18:3i", unidad: "mg" },
    { nombre: "PUFA 18:3 n-3 c,c,c (ALA)", unidad: "mg" },
    { nombre: "PUFA 18:3 n-6 c,c,c", unidad: "mg" },
    { nombre: "PUFA 18:3 c", unidad: "mg" },
    { nombre: "PUFA 18:4", unidad: "mg" },
    { nombre: "PUFA 20:2 n-6 c,c", unidad: "mg" },
    { nombre: "PUFA 20:2 c", unidad: "mg" },
    { nombre: "PUFA 20:3", unidad: "mg" },
    { nombre: "PUFA 20:3 n-3", unidad: "mg" },
    { nombre: "PUFA 20:3 n-6", unidad: "mg" },
    { nombre: "PUFA 20:3 n-9", unidad: "mg" },
    { nombre: "PUFA 20:3 c", unidad: "mg" },
    { nombre: "PUFA 20:4", unidad: "mg" },
    { nombre: "PUFA 20:4 n-3", unidad: "mg" },
    { nombre: "PUFA 20:4 n-6", unidad: "mg" },
    { nombre: "PUFA 20:4c", unidad: "mg" },
    { nombre: "PUFA 20:5 n-3 (EPA)", unidad: "mg" },
    { nombre: "PUFA 20:5c", unidad: "mg" },
    { nombre: "PUFA 21:5", unidad: "mg" },
    { nombre: "PUFA 22:2", unidad: "mg" },
    { nombre: "PUFA 22:3", unidad: "mg" },
    { nombre: "PUFA 22:4", unidad: "mg" },
    { nombre: "PUFA 22:5 n-3 (DPA)", unidad: "mg" },
    { nombre: "PUFA 22:5 c", unidad: "mg" },
    { nombre: "PUFA 22:6 n-3 (DHA)", unidad: "mg" },
    { nombre: "PUFA 22:6 c", unidad: "mg" },
    { nombre: "Fatty acids, total polyunsaturated", unidad: "g" },
  ],
  "√Åcidos Grasos Trans (TFA)": [
    { nombre: "TFA 14:1 t", unidad: "mg" },
    { nombre: "TFA 16:1 t", unidad: "mg" },
    { nombre: "TFA 17:1 t", unidad: "mg" },
    { nombre: "TFA 18:1 t", unidad: "mg" },
    { nombre: "TFA 18:2 t not further defined", unidad: "mg" },
    { nombre: "TFA 18:2 t", unidad: "mg" },
    { nombre: "TFA 18:2 t,t", unidad: "mg" },
    { nombre: "TFA 20:1 t", unidad: "mg" },
    { nombre: "TFA 22:1 t", unidad: "mg" },
    { nombre: "Fatty acids, total trans", unidad: "g" },
    { nombre: "Fatty acids, total trans-monoenoic", unidad: "g" },
    { nombre: "Fatty acids, total trans-dienoic", unidad: "g" },
    { nombre: "Fatty acids, total trans-polyenoic", unidad: "g" },
    { nombre: "Fatty acids, other than 607‚Äì615, 617‚Äì621, 624‚Äì632, 652‚Äì654, 686‚Äì689)", unidad: "g" },
  ],
  "√çndice de calidad de grasa": [
    { nombre: "(SFA:PUFA ratio, n-6:n-3)", unidad: "mg" },
  ],
  "Macrominerales": [
    { nombre: "Calcium (Ca)", unidad: "mg" },
    { nombre: "Phosphorus (P)", unidad: "mg" },
    { nombre: "Potassium (K)", unidad: "mg" },
    { nombre: "Sodium (Na)", unidad: "mg" },
    { nombre: "Magnesium (Mg)", unidad: "mg" },
    { nombre: "Chlorine (Cl)", unidad: "mg" },
    { nombre: "Sulfur (S)", unidad: "mg" },
  ],
  "Microminerales (oligoelementos)": [
    { nombre: "Iron (Fe)", unidad: "mg" },
    { nombre: "Iron, heme", unidad: "mg" },
    { nombre: "Iron, non-heme", unidad: "mg" },
    { nombre: "Zinc (Zn)", unidad: "mg" },
    { nombre: "Copper (Cu)", unidad: "mg" },
    { nombre: "Iodine (I)", unidad: "mg" },
    { nombre: "Selenium (Se)", unidad: "mg" },
    { nombre: "Manganese (Mn)", unidad: "mg" },
    { nombre: "Molybdenum (Mo)", unidad: "mg" },
    { nombre: "Chromium (Cr)", unidad: "mg" },
    { nombre: "Cobalt (Co)", unidad: "mg" },
  ],
  "Minerales posiblemente esenciales": [
    { nombre: "Boron (B)", unidad: "mg" },
    { nombre: "Silicon (Si)", unidad: "mg" },
    { nombre: "Nickel (Ni)", unidad: "mg" },
    { nombre: "Vanadium (V)", unidad: "mg" },
    { nombre: "Lithium (Li)", unidad: "mg" },
    { nombre: "Rubidium (Rb)", unidad: "mg" },
    { nombre: "Tin (Sn)", unidad: "mg" },
    { nombre: "Strontium (Sr)", unidad: "mg" },
  ],
  "Elementos no esenciales o t√≥xicos": [
    { nombre: "Aluminum (Al)", unidad: "mg" },
    { nombre: "Antimony (Sb)", unidad: "mg" },
    { nombre: "Arsenic (As)", unidad: "mg" },
    { nombre: "Barium (Ba)", unidad: "mg" },
    { nombre: "Beryllium (Be)", unidad: "mg" },
    { nombre: "Cadmium (Cd)", unidad: "mg" },
    { nombre: "Gold (Au)", unidad: "mg" },
    { nombre: "Lead (Pb)", unidad: "mg" },
    { nombre: "Mercury (Hg)", unidad: "mg" },
    { nombre: "Silver (Ag)", unidad: "mg" },
    { nombre: "Titanium (Ti)", unidad: "mg" },
    { nombre: "Bromine (Br)", unidad: "mg" },
  ],
  "Otros compuestos minerales": [
    { nombre: "Salt (NaCl)", unidad: "mg" },
    { nombre: "Fluoride (F)", unidad: "mg" },
  ],
  "Vitamina A": [
    { nombre: "Vitamin A", unidad: "¬µg" },
    { nombre: "Retinol", unidad: "¬µg" },
  ],
  "Carotenoides precursores de vitamina A": [
    { nombre: "Carotene", unidad: "mg" },
    { nombre: "Carotene, beta", unidad: "mg" },
    { nombre: "cis-beta-Carotene", unidad: "mg" },
    { nombre: "Carotene, alpha", unidad: "valor" },
    { nombre: "Carotene, gamma", unidad: "mg" },
    { nombre: "Cryptoxanthin, beta", unidad: "mg" },
  ],
  "Carotenoides no precursores de vitamina A": [
    { nombre: "Lycopene", unidad: "mg" },
    { nombre: "cis-Lycopene", unidad: "mg" },
    { nombre: "Lutein", unidad: "mg" },
    { nombre: "Zeaxanthin", unidad: "mg" },
    { nombre: "Lutein + zeaxanthin", unidad: "mg" },
    { nombre: "cis-Lutein/Zeaxanthin", unidad: "mg" },
    { nombre: "Phytoene", unidad: "valor" },
    { nombre: "Phytofluene", unidad: "valor" },
  ],
  "Vitamina D": [
    { nombre: "Vitamin D", unidad: "¬µg" },
    { nombre: "Vitamin D (D2 + D3)", unidad: "¬µg" },
    { nombre: "Vitamin D2 (ergocalciferol)", unidad: "¬µg" },
    { nombre: "Vitamin D3 (cholecalciferol)", unidad: "¬µg" },
    { nombre: "Vitamin D4", unidad: "¬µg" },
    { nombre: "25-hydroxycholecalciferol", unidad: "mg" },
    { nombre: "25-hydroxyergocalciferol", unidad: "mg" },
  ],
  "Vitamina E": [
    { nombre: "Vitamin E", unidad: "¬µg" },
    { nombre: "Vitamin E (alpha-tocopherol)", unidad: "¬µg" },
    { nombre: "Vitamin E (label entry primarily)", unidad: "¬µg" },
  ],
  "Tocopheroles": [
    { nombre: "Tocopherol, alpha", unidad: "¬µg" },
    { nombre: "Tocopherol, beta", unidad: "¬µg" },
    { nombre: "Tocopherol, gamma", unidad: "¬µg" },
    { nombre: "Tocopherol, delta", unidad: "¬µg" },
    { nombre: "Total Tocopherols", unidad: "¬µg" },
  ],
  "Tocotrienoles": [
    { nombre: "Tocotrienol, alpha", unidad: "valor" },
    { nombre: "Tocotrienol, beta", unidad: "mg" },
    { nombre: "Tocotrienol, gamma", unidad: "mg" },
    { nombre: "Tocotrienol, delta", unidad: "mg" },
    { nombre: "Total Tocotrienols", unidad: "mg" },
  ],
  "Vitamina K": [
    { nombre: "Vitamin K (phylloquinone)", unidad: "¬µg" },
    { nombre: "Vitamin K (menaquinonas 7‚Äì13)", unidad: "¬µg" },
    { nombre: "Vitamin K (Dihydrophylloquinone)", unidad: "¬µg" },
    { nombre: "Vitamin K (Menaquinone-4)", unidad: "¬µg" },
  ],
  "Vitamina C": [
    { nombre: "Vitamin C, total ascorbic acid", unidad: "mg" },
    { nombre: "Vitamin C, reduced ascorbic acid", unidad: "mg" },
    { nombre: "Vitamin C, dehydro ascorbic acid", unidad: "mg" },
  ],
  "Vitamina B1 (Tiamina)": [
    { nombre: "Thiamin", unidad: "mg" },
  ],
  "Vitamina B2 (Riboflavina)": [
    { nombre: "Riboflavin", unidad: "mg" },
  ],
  "Vitamina B3 (Niacina)": [
    { nombre: "Niacin", unidad: "mg" },
    { nombre: "Niacin from tryptophan, determined", unidad: "g" },
    { nombre: "Niacin equivalent N406 + N407", unidad: "mg" },
  ],
  "Vitamina B5 (√Åcido pantot√©nico)": [
    { nombre: "Pantothenic acid", unidad: "mg" },
  ],
  "Vitamina B6": [
    { nombre: "Vitamin B-6", unidad: "¬µg" },
    { nombre: "Vitamin B-6, pyridoxine (alcohol form)", unidad: "mg" },
    { nombre: "Vitamin B-6, pyridoxal (aldehyde form)", unidad: "¬µg" },
    { nombre: "Vitamin B-6, pyridoxamine (amine form)", unidad: "¬µg" },
    { nombre: "Vitamin B-6, N411 + N412 + N413 *(combinaci√≥n de formas anteriores)*", unidad: "¬µg" },
  ],
  "Vitamina B7 (Biotina)": [
    { nombre: "Biotin", unidad: "¬µg" },
  ],
  "Vitamina B8 (inositol)": [
    { nombre: "Inositol", unidad: "mg" },
    { nombre: "Inositol phosphate", unidad: "valor" },
  ],
  "Vitamina B9 (Folato)": [
    { nombre: "Folate, total", unidad: "¬µg" },
    { nombre: "Folate, food", unidad: "¬µg" },
    { nombre: "Folate, free", unidad: "¬µg" },
    { nombre: "Folate, not 5-MTHF", unidad: "¬µg" },
    { nombre: "Folate, DFE (Dietary Folate Equivalents)", unidad: "¬µg" },
    { nombre: "Folic acid", unidad: "mg" },
    { nombre: "5-methyl tetrahydrofolate (5-MTHF)", unidad: "¬µg" },
    { nombre: "10-Formyl folic acid (10HCOFA)", unidad: "mg" },
    { nombre: "5-Formyltetrahydrofolic acid (5-HCOH4)", unidad: "mg" },
    { nombre: "Tetrahydrofolic acid (THF)", unidad: "mg" },
  ],
  "Vitamina B12": [
    { nombre: "Vitamin B-12", unidad: "¬µg" },
    { nombre: "Choline", unidad: "¬µg" },
    { nombre: "Choline, total", unidad: "¬µg" },
    { nombre: "Choline, from phosphocholine", unidad: "¬µg" },
    { nombre: "Choline, from phosphotidyl choline", unidad: "¬µg" },
    { nombre: "Choline, from glycerophosphocholine", unidad: "¬µg" },
    { nombre: "Betaine", unidad: "mg" },
    { nombre: "Vitamins and Other Components", unidad: "¬µg" },
  ],
  "Amino√°cidos esenciales": [
    { nombre: "Tryptophan", unidad: "g" },
    { nombre: "Threonine", unidad: "mg" },
    { nombre: "Isoleucine", unidad: "g" },
    { nombre: "Leucine", unidad: "g" },
    { nombre: "Lysine", unidad: "g" },
    { nombre: "Methionine", unidad: "mg" },
    { nombre: "Phenylalanine", unidad: "g" },
    { nombre: "Valine", unidad: "mg" },
    { nombre: "Histidine", unidad: "g" },
  ],
  "Amino√°cidos condicionalmente esenciales": [
    { nombre: "Arginine", unidad: "mg" },
    { nombre: "Cystine", unidad: "mg" },
    { nombre: "Tyrosine", unidad: "mg" },
    { nombre: "Glutamine", unidad: "g" },
    { nombre: "Proline", unidad: "mg" },
    { nombre: "Serine", unidad: "mg" },
  ],
  "Amino√°cidos no esenciales": [
    { nombre: "Alanine", unidad: "g" },
    { nombre: "Aspartic acid", unidad: "mg" },
    { nombre: "Glutamic acid", unidad: "mg" },
    { nombre: "Glycine", unidad: "mg" },
    { nombre: "Asparagine", unidad: "mg" },
    { nombre: "Cysteine", unidad: "mg" },
    { nombre: "Hydroxyproline", unidad: "mg" },
    { nombre: "Taurine", unidad: "mg" },
  ],
  "Grupos funcionales / combinados": [
    { nombre: "DIAAS", unidad: "mg" },
    { nombre: "PDCAAS", unidad: "mg" },
    { nombre: "Amino acid score", unidad: "mg" },
    { nombre: "Limiting amino acid report", unidad: "mg" },
    { nombre: "Cysteine and methionine *(azufrados / sulfur containing AA)*", unidad: "mg" },
    { nombre: "Phenylalanine and tyrosine *(arom√°ticos / aromatic AA)*", unidad: "g" },
  ],
  "Isoflavonas": [
    { nombre: "Daidzein", unidad: "mg" },
    { nombre: "Genistein", unidad: "mg" },
    { nombre: "Glycitein", unidad: "mg" },
    { nombre: "Biochanin A", unidad: "mg" },
    { nombre: "Formononetin", unidad: "mg" },
    { nombre: "Coumestrol", unidad: "mg" },
    { nombre: "Isoflavones, total", unidad: "mg" },
  ],
  "Antocianidinas": [
    { nombre: "Cyanidin", unidad: "mg" },
    { nombre: "Delphinidin", unidad: "valor" },
    { nombre: "Malvidin", unidad: "mg" },
    { nombre: "Pelargonidin", unidad: "mg" },
    { nombre: "Peonidin", unidad: "mg" },
    { nombre: "Petunidin", unidad: "mg" },
    { nombre: "Anthocyanidins, total", unidad: "mg" },
  ],
  "Proantocianidinas": [
    { nombre: "Proanthocyanidin (A-type dimer)", unidad: "mg" },
    { nombre: "Proanthocyanidin monomers", unidad: "mg" },
    { nombre: "Proanthocyanidin dimers", unidad: "mg" },
    { nombre: "Proanthocyanidin trimers", unidad: "mg" },
    { nombre: "Proanthocyanidin 4‚Äì6mers", unidad: "mg" },
    { nombre: "Proanthocyanidin 7‚Äì10mers", unidad: "mg" },
    { nombre: "Proanthocyanidin polymers (>10mers)", unidad: "mg" },
    { nombre: "Procyanidins, total", unidad: "mg" },
  ],
  "Catequinas": [
    { nombre: "Catechin", unidad: "mg" },
    { nombre: "Epigallocatechin", unidad: "mg" },
    { nombre: "Epicatechin", unidad: "mg" },
    { nombre: "Epicatechin-3-gallate", unidad: "mg" },
    { nombre: "Epigallocatechin-3-gallate", unidad: "mg" },
    { nombre: "(+)-Gallocatechin", unidad: "mg" },
    { nombre: "(+)-Catechin 3-gallate", unidad: "mg" },
    { nombre: "(+)-Gallocatechin 3-gallate", unidad: "mg" },
    { nombre: "Catechins, total", unidad: "mg" },
  ],
  "Flavans": [
    { nombre: "Theaflavins", unidad: "mg" },
    { nombre: "Theaflavin-3-gallate", unidad: "mg" },
    { nombre: "Theaflavin-3'-gallate", unidad: "mg" },
    { nombre: "Theaflavin-3,3'-digallate", unidad: "mg" },
    { nombre: "Thearubigins", unidad: "mg" },
    { nombre: "Flavans, total", unidad: "mg" },
  ],
  "Flavanonas": [
    { nombre: "Eriodictyol", unidad: "mg" },
    { nombre: "Hesperetin", unidad: "mg" },
    { nombre: "Isosakuranetin", unidad: "mg" },
    { nombre: "Liquiritigenin", unidad: "mg" },
    { nombre: "Naringenin", unidad: "mg" },
    { nombre: "Flavanones, total", unidad: "mg" },
  ],
  "Flavonas": [
    { nombre: "Apigenin", unidad: "mg" },
    { nombre: "Chrysoeriol", unidad: "mg" },
    { nombre: "Diosmetin", unidad: "mg" },
    { nombre: "Luteolin", unidad: "mg" },
    { nombre: "Nobiletin", unidad: "mg" },
    { nombre: "Sinensetin", unidad: "mg" },
    { nombre: "Tangeretin", unidad: "mg" },
    { nombre: "Flavones, total", unidad: "mg" },
  ],
  "Flavonoles": [
    { nombre: "Isorhamnetin", unidad: "mg" },
    { nombre: "Kaempferol", unidad: "mg" },
    { nombre: "Limocitrin", unidad: "mg" },
    { nombre: "Myricetin", unidad: "mg" },
    { nombre: "Quercetin", unidad: "mg" },
    { nombre: "Theogallin", unidad: "mg" },
    { nombre: "Flavonols, total", unidad: "mg" },
  ],
  "√Åcidos fen√≥licos": [
    { nombre: "Gallic acid", unidad: "mg" },
    { nombre: "Chlorogenic acid", unidad: "mg" },
    { nombre: "p-Hydroxybenzoic acid", unidad: "mg" },
    { nombre: "Caffeic acid", unidad: "mg" },
    { nombre: "p-Coumaric acid", unidad: "mg" },
    { nombre: "Ellagic acid", unidad: "mg" },
    { nombre: "Ferulic acid", unidad: "mg" },
    { nombre: "Cinnamic acid *(tambi√©n fen√≥lico)*", unidad: "mg" },
    { nombre: "Salicylic acid *(tambi√©n fen√≥lico)*", unidad: "mg" },
    { nombre: "Gentisic acid", unidad: "mg" },
    { nombre: "Tyrosol *(alcohol fen√≥lico)*", unidad: "mg" },
    { nombre: "Vanillic acid", unidad: "mg" },
    { nombre: "Phenolic acids, total", unidad: "mg" },
    { nombre: "Total Phenolics", unidad: "mg" },
  ],
  "Polifenoles totales": [
    { nombre: "Polyphenols, total", unidad: "mg" },
  ],
"√Åcidos monocarbox√≠licos": [
  { nombre: "Acetic acid", unidad: "mg" },
  { nombre: "Butyric acid", unidad: "mg" },
  { nombre: "Propionic acid", unidad: "mg" },
  { nombre: "Glycolic acid", unidad: "mg" },
  { nombre: "Lactic acid", unidad: "mg" },
  { nombre: "Pyruvic acid", unidad: "mg" },
],
  "√Åcidos dicarbox√≠licos": [
    { nombre: "Malic acid", unidad: "mg" },
    { nombre: "Succinic acid", unidad: "mg" },
    { nombre: "Oxaloacetic acid", unidad: "mg" },
    { nombre: "Fumaric acid", unidad: "mg" },
    { nombre: "Tartaric acid", unidad: "mg" },
    { nombre: "Oxalic acid", unidad: "mg" },
  ],
  "√Åcidos tricarbox√≠licos": [
    { nombre: "Citric acid", unidad: "mg" },
    { nombre: "Isocitric acid", unidad: "mg" },
    { nombre: "Aconitic acid", unidad: "mg" },
  ],
  "√Åcidos derivados de az√∫cares": [
    { nombre: "Galacturonic acid", unidad: "mg" },
    { nombre: "Quinic acid", unidad: "mg" },
  ],
  "√Åcidos arom√°ticos o especiales": [
    { nombre: "Benzoic acid", unidad: "mg" },
    { nombre: "Chelidonic acid", unidad: "mg" },
  ],
  "√Åcidos polifosforilados / quelantes": [
    { nombre: "Phytic acid", unidad: "mg" },
  ],
  "√Åcidos terpenoides": [
    { nombre: "Ursolic acid", unidad: "mg" },
  ],
  "P√©ptidos y derivados bioactivos": [
    { nombre: "Glutathione", unidad: "mg" },
    { nombre: "Carnosine", unidad: "mg" },
    { nombre: "Anserine", unidad: "mg" },
    { nombre: "Lactoferricin", unidad: "mg" },
    { nombre: "Soy peptides", unidad: "mg" },
    { nombre: "Collagen peptides", unidad: "mg" },
    { nombre: "Ergothioneine", unidad: "mg" },
  ],
  "Estilbenos": [
    { nombre: "Resveratrol", unidad: "mg" },
    { nombre: "Pterostilbene", unidad: "mg" },
  ],
  "Lignanos": [
    { nombre: "Secoisolariciresinol", unidad: "mg" },
    { nombre: "Matairesinol", unidad: "mg" },
    { nombre: "Lariciresinol", unidad: "mg" },
    { nombre: "Pinoresinol", unidad: "mg" },
  ],
  "Taninos hidrolizables": [
    { nombre: "Punicalagin", unidad: "mg" },
    { nombre: "Geraniin", unidad: "mg" },
  ],
  "Anti nutrientes": [
    { nombre: "Oxalates", unidad: "mg" },
    { nombre: "Tannic acid", unidad: "mg" },
    { nombre: "Lectins, saponins", unidad: "mg" },
  ],
  "Alcaloides": [
    { nombre: "Piperine", unidad: "mg" },
    { nombre: "Caffeine", unidad: "mg" },
    { nombre: "Theobromine", unidad: "mg" },
    { nombre: "Theophylline", unidad: "valor" },
  ],
  "Glucosinolatos": [
    { nombre: "Sulforaphane", unidad: "valor" },
    { nombre: "Glucoraphanin", unidad: "valor" },
    { nombre: "Glucobrassicin", unidad: "mg" },
    { nombre: "Sinigrin", unidad: "mg" },
    { nombre: "Gluconasturtiin", unidad: "mg" },
  ],
  "Fitoesteroles": [
    { nombre: "Phytosterols", unidad: "valor" },
    { nombre: "Ergosterol", unidad: "mg" },
    { nombre: "Stigmasterol", unidad: "mg" },
    { nombre: "Campesterol", unidad: "mg" },
    { nombre: "Brassicasterol", unidad: "mg" },
    { nombre: "Beta-sitosterol", unidad: "mg" },
    { nombre: "Campestanol", unidad: "mg" },
    { nombre: "Beta-sitostanol", unidad: "mg" },
    { nombre: "Delta-7-avenasterol", unidad: "mg" },
    { nombre: "Delta-5-avenasterol", unidad: "mg" },
    { nombre: "Alpha-spinasterol", unidad: "valor" },
    { nombre: "Phytosterols, other", unidad: "valor" },
  ],
  "Fitoesteroles derivados del ergostano": [
    { nombre: "Ergosta-7-enol", unidad: "mg" },
    { nombre: "Ergosta-7,22-dienol", unidad: "mg" },
    { nombre: "Ergosta-5,7-dienol", unidad: "mg" },
    { nombre: "*(Precursores esteroides f√∫ngicos o vegetales relacionados a ergosterol)*", unidad: "mg" },
  ],
  "Carotenoides": [
    { nombre: "trans-beta-Carotene", unidad: "mg" },
    { nombre: "trans-Lycopene", unidad: "mg" },
    { nombre: "Cryptoxanthin, alpha", unidad: "valor" },
    { nombre: "Other carotenoids", unidad: "mg" },
  ],
  "Otros lipidos": [
    { nombre: "Cholesterol", unidad: "mg" },
    { nombre: "Glycerides", unidad: "mg" },
    { nombre: "Phospholipids", unidad: "g" },
    { nombre: "Glycolipids", unidad: "g" },
  ],
  "Compuestos nitrogenados": [
    { nombre: "Nitrates", unidad: "mg" },
    { nombre: "Nitrites", unidad: "mg" },
    { nombre: "Nitrosamines, total *(potencialmente carcin√≥genas)*", unidad: "mg" },
  ],
  "Propiedades fisicoqu√≠micas": [
    { nombre: "pH", unidad: "valor" },
    { nombre: "Specific Gravity", unidad: "mg" },
    { nombre: "Alcohol, ethyl", unidad: "mg" },
  ],
  "Probi√≥ticos": [
  { nombre: "Lactobacillus spp.", unidad: "millones de CFU" },
  { nombre: "Bifidobacterium spp.", unidad: "millones de CFU" },
  { nombre: "Saccharomyces boulardii", unidad: "millones de CFU" },
  { nombre: "Streptococcus thermophilus", unidad: "millones de CFU" },
  { nombre: "Lactococcus lactis", unidad: "millones de CFU" },
],
"Marcadores metab√≥licos": [
  { nombre: "Creatinine", unidad: "mg" },
],
"Polifenoles": [
  { nombre: "Curcumin", unidad: "mg" },
],
};

const nutrientesPlanos = [];
let vdr = {};  // Inicializado vac√≠o para evitar errores antes de llenarse din√°micamente
for (const [categoria, lista] of Object.entries(nutrientes)) {
  lista.forEach(n => {
    nutrientesPlanos.push({ ...n, categoria });
  });
}

const alimentos = [
  {
    id: "a1",
    nombre: "Manzana",
    categoria: "Frutas",
    composicion: {
      "Energ√≠a": 52,
      "Carbohidratos": 14,
      "Fibra": 2.4
    }
  },
  {
    id: "a2",
    nombre: "Leche",
    categoria: "L√°cteos",
    composicion: {
      "Energ√≠a": 42,
      "Prote√≠nas": 3.4,
      "Grasas totales": 1,
      "Calcio": 120
    }
  },
  {
    id: "a3",
    nombre: "Pan integral",
    categoria: "Cereales",
    composicion: {
      "Energ√≠a": 250,
      "Carbohidratos": 40,
      "Prote√≠nas": 8,
      "Fibra": 6
    }
  },
  {
    id: "a4",
    nombre: "Espinaca",
    categoria: "Verduras",
    composicion: {
      "Energ√≠a": 23,
      "Fibra": 2.2,
      "Hierro": 2.7,
      "Calcio": 99
    }
  },
  {
    id: "a5",
    nombre: "Pechuga de pollo",
    categoria: "Carnes",
    composicion: {
      "Energ√≠a": 165,
      "Prote√≠nas": 31,
      "Grasas totales": 3.6
    }
  }
];
let formularioVDRInicializado = false;
    const datosComidas = {}, datosManuales = {}, graficos = {};
    
    
  </script>
<script>
  const contenedor = document.getElementById("contenedor-comidas");

  comidas.forEach(comida => {
  datosComidas[comida] = [];
  datosManuales[comida] = {};
  
  crearEstructuraHTML(comida);
  inicializarAutocompletado(comida);
  });
  
  function crearEstructuraHTML(comida) {
  const section = document.createElement("div");
  section.className = "section";
  section.innerHTML = `
<section class="seccion-comida">
  <div>
    <!-- Selector de categor√≠as -->
    <select id="cat-${comida}">
      <option value="">Todas las categor√≠as</option>
      ${categorias.map(c => `<option value="${c}">${c}</option>`).join("")}
    </select>

    <!-- Nombre de la comida -->
    <h2 style="font-size: 12px; font-weight: 600; margin: 0; padding-left: 9px; padding-bottom: 0px;">
      ${comida}:
    </h2>

    <!-- Input + Sugerencias + Peso -->
    <div style="display: flex; align-items: flex-start; gap: 0.5rem; margin: 0rem 0;">
      
      <!-- Input buscador y lista sugerencias -->
      <div style="display: flex; flex-direction: column; position: relative; width: 77%;">
<div
  id="buscar-${comida}"
  contenteditable="true"
  placeholder="Buscar alimento"
  class="bg-white border border-gray-300 rounded px-1 py-1 mb-1"
  style="width: 100%; border-radius: 8px; margin-bottom: 4px; min-height: 1.5em; font-size: 12px; padding-left: 8px;"
></div>

<ul
  id="sugerencias-${comida}"
  class="sugerencias-lista"
  style="font-size: 12px; padding-left: 9px;"
></ul>
      </div>

<div style="display: flex; align-items: center; width: 23%;">
  <span style="font-size: 12px; font-weight: 600; margin-right: 4px; line-height: 1.5; display: flex; align-items: center;">g:</span>
  <div
    id="peso-${comida}"
    contenteditable="true"
    class="bg-white border border-gray-300 rounded px-2 py-1 mb-1"
    style="min-width: 60px; text-align: center; border-radius: 8px; font-size: 12px; line-height: 1.5;"
    placeholder="Peso"
  ></div>
      </div>
    </div>

    <!-- Lista de alimentos agregados -->
    <div id="lista-agregados-${comida}" style="margin-top: 0px; margin-bottom: 0px; font-size: 12px;">
      <ul></ul>
    </div>

    <!-- Bot√≥n -->
    <div id="contenedor-boton-${comida}" style="display: none;">
      <button class="btn-grafica" onclick="toggleSeccion('${comida}')">
        Ocultar tabla y gr√°fico
      </button>
    </div>
  </div>
</section>

<div class="tablas-grafico hidden" id="seccion-${comida}">
    <!-- T√≠tulo del gr√°fico -->
    <h3 style="font-size: 15px; font-weight: 600; margin-bottom: 0.5rem; text-align: center;">
      Gr√°fico nutricional
    </h3>
    <canvas id="grafico-${comida}"></canvas>

  <section>
    <!-- Bot√≥n para activar edici√≥n -->
    <button class="btn-toggle-nutrientes" onclick="toggleMostrarNutrientes()">Mostrar todos los nutrientes</button>
    
    <button class="btn-editor" id="btn-editor-${comida}" style="display: none;">
      Agregar nutrientes
    </button>

    <!-- T√≠tulo de la tabla principal -->
    <h3 style="font-size: 15px; font-weight: 600; margin-top: 1rem; text-align: center;">
      Tabla de nutrientes
    </h3>
    <table class="tabla" id="contenedor-tabla-${comida}" style="display: none;"> 
      <thead>
        <tr><th>Nutriente</th><th>Cantidad</th><th>Unidad</th><th>VDR%</th></tr>
      </thead>  
      <tbody id="tabla-${comida}"></tbody>  
    </table>

    <!-- T√≠tulo de la tabla editable -->
    <table class="tabla" id="contenedor-editor-${comida}" style="display: none;">  
      <thead>
        <tr><th>Nutriente</th><th>Cantidad</th><th>Unidad</th><th>VDR%</th></tr>
      </thead>  
      <tbody id="editor-${comida}"></tbody>  
    </table>

    <!-- Bot√≥n de compartir -->
    <button class="btn-editor" onclick="compartirResultados('${comida}')">
      Compartir resultados
    </button>
  </section>
</div>
`;
  contenedor.appendChild(section);
  inicializarPlaceholders();
  alternarTablas(comida);
}

function inicializarPlaceholders() {
  document.querySelectorAll('[contenteditable][placeholder]').forEach(div => {
    div.removeEventListener('input', placeholderHandler);
    div.addEventListener('input', placeholderHandler);
  });
}

function placeholderHandler(e) {
  const div = e.target;
  if (div.innerText.trim() === "") {
    div.innerHTML = ""; // para que vuelva el :empty del placeholder
  }
}

function actualizarSeccionComida(comida) {
  const seccion = document.getElementById(`seccion-${comida}`);
  const btn = document.getElementById(`btn-editor-${comida}`);
  const tabla = document.getElementById(`contenedor-tabla-${comida}`);
  
  const hayAlimentos = datosComidas[comida].length > 0;
  
  // üîí Respetar si el usuario ocult√≥ manualmente
  if (!seccion.classList.contains("forzado-oculto")) {
    seccion?.classList.toggle("hidden", !hayAlimentos);
  }
  
  if (tabla) tabla.style.display = hayAlimentos ? "table" : "none";
  if (btn) btn.style.display = hayAlimentos ? "inline-block" : "none";
}


function actualizarVisibilidadSeccionTotal() {
  let comidasConAlimentos = 0;
  
  comidas.forEach(comida => {
    if (datosComidas[comida] && datosComidas[comida].length > 0) {
      comidasConAlimentos++;
    }
  });
  
  const header = document.getElementById("seccion-total-header");
  const seccion = document.getElementById("seccion-total");
  
  if (comidasConAlimentos >= 2) {
    header.classList.remove("hidden");
  } else {
    header.classList.add("hidden");
    seccion.classList.add("hidden");
  }
}

function actualizarVisibilidadBoton(comida) {
  const lista = document.querySelector(`#lista-agregados-${comida} ul`);
  const contenedorBoton = document.getElementById(`contenedor-boton-${comida}`);
  
  if (lista && contenedorBoton) {
    contenedorBoton.style.display = lista.children.length > 0 ? "block" : "none";
  }
}


function formatearNumero(valor) {
  return Number(valor).toLocaleString("es-AR");
}

function inicializarAutocompletado(comida) {
  const divInput = document.getElementById(`buscar-${comida}`);
  const ul = document.getElementById(`sugerencias-${comida}`);
  
  divInput.addEventListener("input", e => {
    const val = e.target.innerText.toLowerCase().trim();
    const cat = document.getElementById(`cat-${comida}`).value;
    const sugerencias = alimentos
      .filter(a =>
        a.nombre.toLowerCase().includes(val) &&
        (!cat || a.categoria === cat)
      )
      .map(a => `<li><button type="button">${a.nombre}</button></li>`);
    
    ul.innerHTML = sugerencias.join("");
    
    ul.querySelectorAll("button").forEach(btn => {
      btn.addEventListener("click", () => {
        agregarAlimentoSeleccionado(comida, btn.textContent);
        ul.innerHTML = "";
        divInput.innerText = ""; // limpiar input editable
      });
    });
  });
  
  document.addEventListener("click", e => {
    if (!divInput.contains(e.target) && !ul.contains(e.target)) {
      ul.innerHTML = "";
      divInput.innerText = "";
    }
  });
}

function tecladoAbierto() {
  const activo = document.activeElement;
  return (
    activo &&
    (
      activo.tagName === "INPUT" ||
      activo.tagName === "TEXTAREA" ||
      activo.isContentEditable
    ) &&
    activo.type !== "checkbox" &&
    activo.type !== "radio"
  );
}

function mostrarToastError(mensaje) {
  const id = "toast-error-overlay";
  if (document.getElementById(id)) return;
  
  const overlay = document.createElement("div");
  overlay.id = id;
  
  const scrollHeight = Math.max(
    document.body.scrollHeight,
    document.documentElement.scrollHeight
  );
  
  overlay.style.cssText = `
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: ${scrollHeight}px;
    background-color: rgba(0, 0, 0, 0.8);
    z-index: 10001;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
  `;
  
  const toast = document.createElement("div");
  toast.textContent = mensaje;
  
  // ‚úÖ Altura visible del viewport
  const visibleHeight = window.visualViewport?.height || window.innerHeight;
  const scrollTop = window.scrollY;
  const offsetY = scrollTop + visibleHeight / 2 - 30;
  
  toast.style.cssText = `
    background: #e53935;
    color: white;
    padding: 10px 16px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 500;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    max-width: 90%;
    text-align: center;
    position: fixed;
    top: ${offsetY}px;
    left: 50%;
    transform: translateX(-50%);
    opacity: 0;
    transition: opacity 0.3s ease, top 0.3s ease;
    z-index: 10002;
  `;
  
  overlay.appendChild(toast);
  document.body.appendChild(overlay);
  
  requestAnimationFrame(() => {
    overlay.style.opacity = "1";
    overlay.style.pointerEvents = "auto";
    toast.style.opacity = "1";
  });
  
  setTimeout(() => {
    toast.style.opacity = "0";
    overlay.style.opacity = "0";
    overlay.style.pointerEvents = "none";
    setTimeout(() => overlay.remove(), 300);
  }, 1000);
}

function agregarAlimentoSeleccionado(comida, nombreAlimento) {
  const pesoInput = document.getElementById(`peso-${comida}`);
  const texto = pesoInput.innerText.replace(",", ".").trim();
  const peso = parseFloat(texto);
  
  if (!peso || peso <= 0) {
    mostrarToastError("‚ö†Ô∏è Por favor ingresa un peso v√°lido");
    pesoInput.focus();
    return;
  }
  
  const alimento = alimentos.find(a => a.nombre === nombreAlimento);
  if (!alimento) return;
  
  datosComidas[comida].push({ alimento, peso });
  pesoInput.innerText = "";
  
  const tabla = document.getElementById(`contenedor-tabla-${comida}`);
  const editor = document.getElementById(`contenedor-editor-${comida}`);
  const btn = document.getElementById(`btn-editor-${comida}`);
  if (tabla && editor && btn) {
    tabla.style.display = "table";
    editor.style.display = "none";
    btn.textContent = "Agregar nutrientes";
  }
  
  actualizarVisibilidadBoton(comida);
  actualizarVisibilidadSeccionTotal();
  actualizarListaAgregados(comida);
  Calculadora();
}

function agregarAlimento(comida) {
  const nombre = document.getElementById(`buscar-${comida}`).value;
  const peso = parseFloat(document.getElementById(`peso-${comida}`).value);
  const alimento = alimentos.find(a => a.nombre === nombre);
  if (!alimento || !peso) return;
  
  datosComidas[comida].push({ alimento, peso });
  
  document.getElementById(`buscar-${comida}`).value = "";
  document.getElementById(`peso-${comida}`).value = "";
  
  const tabla = document.getElementById(`contenedor-tabla-${comida}`);
  const editor = document.getElementById(`contenedor-editor-${comida}`);
  const btn = document.getElementById(`btn-editor-${comida}`);
  if (tabla && editor && btn) {
    tabla.style.display = "table";
    editor.style.display = "none";
    btn.textContent = "Agregar nutrientes";
  }
  
  actualizarVisibilidadBoton(comida);
  actualizarVisibilidadSeccionTotal();
  actualizarListaAgregados(comida);
  Calculadora();
}

function actualizarListaAgregados(comida) {
  const listaContenedor = document.getElementById(`lista-agregados-${comida}`);
  if (!listaContenedor) return;
  
  const ul = listaContenedor.querySelector("ul");
  ul.innerHTML = "";
  
  datosComidas[comida].forEach(({ alimento, peso }, index) => {
    const li = document.createElement("li");
    li.style.cssText = `
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 0;
      padding-left: 9px;
      font-weight: bold;
      font-size: 12px;
    `;
    
    li.textContent = alimento.esManual ?
      alimento.displayManual :
      `${alimento.nombre} (${formatearNumero(peso)} g)`;
    
    const btnEliminar = document.createElement("button");
    btnEliminar.textContent = "‚úñ";
    btnEliminar.style.cssText = `
      width: 19%;
      align-self: flex-end;
      cursor: pointer;
      font-size: 12px;
      margin-top: 0.1px;
      margin-bottom: 1px;
    `;
    
    btnEliminar.addEventListener("click", () => {
  datosComidas[comida].splice(index, 1);
  
  const tabla = document.getElementById(`contenedor-tabla-${comida}`);
  const editor = document.getElementById(`contenedor-editor-${comida}`);
  const btn = document.getElementById(`btn-editor-${comida}`);
  if (tabla && editor && btn) {
    tabla.style.display = "table";
    editor.style.display = "none";
    btn.textContent = "Agregar nutrientes";
  }
  
  actualizarListaAgregados(comida);
  Calculadora();
});
    
    li.appendChild(btnEliminar);
    ul.appendChild(li);
  });
  
  actualizarVisibilidadSeccionTotal();
  actualizarVisibilidadBoton(comida);
  actualizarSeccionComida(comida);
}

function alternarTablas(comida) {
  const btn = document.getElementById(`btn-editor-${comida}`);
  const tabla = document.getElementById(`contenedor-tabla-${comida}`);
  const editor = document.getElementById(`contenedor-editor-${comida}`);
  
  btn.addEventListener("click", () => {
    if (tabla.style.display === "none") {
      // Est√°s en el editor y vas a volver a la tabla
      aplicarManual(comida); // ‚úÖ Guarda lo ingresado
      tabla.style.display = "table";
      editor.style.display = "none";
      btn.textContent = "Agregar nutrientes";
    } else {
      // Est√°s en la tabla y vas a abrir el editor
      inicializarEditorManual(comida, datosManuales[comida] || {}); // ‚úÖ Carga datos previos
      tabla.style.display = "none";
      editor.style.display = "table";
      btn.textContent = "Aplicar nutrientes";
    }
  });
}

function inicializarEditorManual(comida, valoresPrevios = {}) {
  const editor = document.getElementById(`editor-${comida}`);
  editor.innerHTML = "";
  datosManuales[comida] = {};

  const totales = {};
  nutrientesPlanos.forEach(n => totales[n.nombre] = 0);

  datosComidas[comida].forEach(({ alimento, peso }) => {
    nutrientesPlanos.forEach(n => {
      totales[n.nombre] += (alimento.composicion[n.nombre] || 0) * peso / 100;
    });
  });

  let categoriaActual = "";

  nutrientesPlanos.forEach(n => {
    const nombre = n.nombre;
    const unidadBase = n.unidad;
    const categoria = n.categoria;
    const v = vdr[nombre] || 0;

    if (categoria !== categoriaActual) {
      categoriaActual = categoria;
      const rowCat = document.createElement("tr");
      rowCat.innerHTML = `<td colspan="4" style="font-weight:bold; background-color: #f8f8f8; text-align:center;">${categoria}</td>`;
      editor.appendChild(rowCat);
    }

    const valorManual = valoresPrevios[nombre] || "";
    datosManuales[comida][nombre] = valorManual;

    const cantidadConvertida = convertirUnidad(parseFloat(valorManual) || 0, unidadBase, unidadBase);
    const totalCombinado = totales[nombre] + cantidadConvertida;
    const porcVDR = v ? (totalCombinado / v) * 100 : 0;

    const row = document.createElement("tr");
    row.dataset.nutriente = nombre;

    row.innerHTML = `
      <td>${nombre}</td>
      <td>
<div contenteditable="true"
     class="input-editor placeholder flex items-center justify-center bg-white border border-gray-300"
     style="min-width: 60px;">${valorManual}</div>

      </td>
      <td>
        <select class="select-editor" id="unidad-${comida}-${nombre}">
          ${
            (() => {
              let opcionesUnidad = [];
              if (nombre === "Water") {
                opcionesUnidad = ["g", "mg", "mcg", "L", "ml"];
              } else if (nombre === "Energ√≠a") {
                opcionesUnidad = ["kcal", "kJ"];
              } else {
                opcionesUnidad = ["g", "mg", "mcg"];
              }
              return opcionesUnidad.map(u =>
                `<option value="${u}" ${unidadBase === u ? "selected" : ""}>${u}</option>`
              ).join("");
            })()
          }
        </select>
      </td>
      <td id="vdr-${comida}-${nombre}">${porcVDR.toFixed(1)}%</td>
    `;

    editor.appendChild(row);

    const input = row.querySelector(".input-editor");
    const select = row.querySelector("select");
    const vdrCell = document.getElementById(`vdr-${comida}-${nombre}`);

    // ‚úÖ Aplicar color al cargar
    aplicarColorVdr(vdrCell, porcVDR);

    function actualizarVdr() {
      const texto = input.textContent.replace(/[^0-9.,-]/g, "").replace(",", ".").trim();
      const cantidad = parseFloat(texto);
      const unidadActual = select.value;

      if (isNaN(cantidad)) {
        delete datosManuales[comida][nombre];
        const total = totales[nombre];
        const porc = v ? (total / v) * 100 : 0;
        vdrCell.textContent = `${porc.toFixed(1)}%`;
        aplicarColorVdr(vdrCell, porc);
        return;
      }

      datosManuales[comida][nombre] = cantidad;

      const cantidadConvertida = convertirUnidad(cantidad, unidadActual, unidadBase);
      const total = totales[nombre] + cantidadConvertida;
      const porc = v ? (total / v) * 100 : 0;

      vdrCell.textContent = `${porc.toFixed(1)}%`;
      aplicarColorVdr(vdrCell, porc);
    }

    input.addEventListener("input", () => {
      if (input.innerText.trim() === "") input.innerHTML = "";
      actualizarVdr();
    });

    input.addEventListener("blur", actualizarVdr);
    input.addEventListener("paste", () => setTimeout(actualizarVdr, 0));
    select.addEventListener("change", actualizarVdr);
  });

  inicializarPlaceholders();

  function aplicarColorVdr(celda, porc) {
    if (porc > 27.5) {
      celda.style.color = "red";
    } else if (porc >= 22.5) {
      celda.style.color = "green";
    } else {
      celda.style.color = "";
    }
  }
}

function aplicarManual(comida) {
  const datos = datosManuales[comida];
  if (!datos) return false;

  const filasEditor = [...document.querySelectorAll(`#editor-${comida} tr`)]
    .filter(fila => fila.dataset.nutriente);

  let seAgrego = false;

  filasEditor.forEach(fila => {
    const nombreNutriente = fila.dataset.nutriente;
    const input = fila.querySelector('.input-editor'); // ahora es un div
    const select = fila.querySelector('select');

    if (!input || !select || !nombreNutriente) return;

    const texto = input.innerText.replace(",", ".").trim();
    const cantidad = parseFloat(texto);
    const unidadIngresada = select.value;

    const nutrienteBase = nutrientesPlanos.find(n => n.nombre === nombreNutriente);
    const unidadBase = nutrienteBase?.unidad || unidadIngresada;

    // Si es 0 o NaN, eliminar alimento manual si existe
    if (!isNaN(cantidad) && cantidad === 0) {
      datosComidas[comida] = datosComidas[comida].filter(({ alimento }) => {
        return !alimento.nombre.startsWith(`${nombreNutriente} (`);
      });
      return;
    }

    // Si es v√°lido y no cero, agregar o reemplazar alimento manual
    if (!isNaN(cantidad) && cantidad !== 0) {
      const cantidadConvertida = convertirUnidad(cantidad, unidadIngresada, unidadBase);
      const cantidadFormateada = formatearNumero(cantidad);

      const alimento = {
        nombre: nombreNutriente,
        composicion: { [nombreNutriente]: cantidadConvertida },
        unidadesPersonalizadas: {
          [nombreNutriente]: { valor: cantidad, unidad: unidadIngresada }
        },
        displayManual: `${nombreNutriente} (${cantidadFormateada} ${unidadIngresada})`,
        esManual: true
      };

      datosComidas[comida].push({ alimento, peso: 100 });
      seAgrego = true;
    }
  });

  if (!seAgrego) return false;

  actualizarVisibilidadBoton(comida);
actualizarListaAgregados(comida);
Calculadora();

  // Limpiar campos
  filasEditor.forEach(fila => {
    const input = fila.querySelector('.input-editor');
    if (input) input.innerText = "";
    const vdrCell = fila.querySelector('td:last-child');
    if (vdrCell) vdrCell.textContent = "0%";
  });

  Object.keys(datos).forEach(k => datos[k] = 0);

  return true;
}

function convertirUnidad(valor, unidadOrigen, unidadDestino) {
  if (unidadOrigen === unidadDestino) return valor;
  
  const conversiones = {
    g: { g: 1, mg: 1000, mcg: 1_000_000 },
    mg: { g: 1 / 1000, mg: 1, mcg: 1000 },
    mcg: { g: 1 / 1_000_000, mg: 1 / 1000, mcg: 1 },
    L: { L: 1, ml: 1000, g: 1000 },
    ml: { L: 1 / 1000, ml: 1, g: 1 },
    g: { ...this?.g, ml: 1 },
    ml: { ...this?.ml, g: 1 },
    kcal: { kcal: 1, kJ: 4.184 },
    kJ: { kJ: 1, kcal: 1 / 4.184 }
  };
  
  if (
    !conversiones[unidadOrigen] ||
    !conversiones[unidadOrigen][unidadDestino]
  ) {
    console.warn(`Conversi√≥n no soportada: ${unidadOrigen} ‚Üí ${unidadDestino}`);
    return NaN;
  }
  
  return valor * conversiones[unidadOrigen][unidadDestino];
}
  
  function formatoNumeroInteligente(num) {
  if (Number.isInteger(num)) {
    // entero, formatear sin decimales pero con separador de miles
    return num.toLocaleString('es-AR', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
  } else {
    // decimal, mostrar 2 decimales con separador de miles
    return num.toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  }
}

let perfilesFuncionalesRenderizados = false;

function toggleSeccion(id) {
  const seccion = document.getElementById("seccion-" + id);
  const btnToggle =
    document.querySelector(`#contenedor-boton-${id} button`) ||
    document.querySelector(`#seccion-${id}-header .btn-total`);
  
  const visible = !seccion.classList.contains("hidden");
  
  if (visible) {
    seccion.classList.add("hidden");
    seccion.classList.add("forzado-oculto");
  } else {
    seccion.classList.remove("hidden");
    seccion.classList.remove("forzado-oculto");
    
    // ‚úÖ Renderizar solo una vez si es "total"  
    if (id === "total" && !perfilesFuncionalesRenderizados) {
        renderizarPerfilesFuncionales();
      
      perfilesFuncionalesRenderizados = true;
    }
    
  }
  
  if (btnToggle) {
    btnToggle.textContent = visible ?
      "Mostrar tabla y gr√°fico" :
      "Ocultar tabla y gr√°fico";
  }
}


let mostrarTodosLosNutrientes = false;

function Calculadora() {
  // üîÅ Actualiza VDR antes de cualquier c√°lculo
  document.querySelectorAll('#formulario-vdr .input-editor[data-nutriente]').forEach(div => {
    const nombre = div.dataset.nutriente;
    const texto = div.innerText.replace(",", ".").trim();
    const valor = parseFloat(texto);
    if (!isNaN(valor)) {
      vdr[nombre] = valor;
    }
  });
  
  perfilesFuncionalesRenderizados = false; // Permite volver a renderizar perfiles funcionales  
  datosComidas.total = [];
  
  comidas.forEach(comida => {
    const check = document.getElementById(`check-${comida}`);
    if (!check || check.checked) {
      datosComidas[comida].forEach(({ alimento, peso }) => {
        datosComidas.total.push({ alimento, peso });
      });
    }
  });
  
  [...comidas, "total"].forEach(comida => {
    const totales = {};
    nutrientesPlanos.forEach(n => totales[n.nombre] = 0);
    
    datosComidas[comida].forEach(({ alimento, peso }) => {
      nutrientesPlanos.forEach(n => {
        totales[n.nombre] += (alimento.composicion[n.nombre] || 0) * peso / 100;
      });
    });
    
    const tabla = document.getElementById(`tabla-${comida}`);
    if (tabla) {
      tabla.innerHTML = "";
      let categoriaActual = "";
      
      nutrientesPlanos.forEach(n => {
        const val = totales[n.nombre];
        const porc = vdr[n.nombre] ? (val / vdr[n.nombre]) * 100 : 0;
        
        // Mostrar todos o solo los nutrientes con valor
        if (mostrarTodosLosNutrientes || val > 0) {
          if (n.categoria !== categoriaActual) {
            categoriaActual = n.categoria;
            const rowCat = document.createElement("tr");
            rowCat.classList.add("categoria-nutriente");
            rowCat.innerHTML = `<td colspan="4" style="font-weight:bold; background-color: #f8f8f8; text-align:center;">${categoriaActual}</td>`;
            tabla.appendChild(rowCat);
          }
          
          let estilo = "";
          if (comida === "total") {
            if (porc > 110) estilo = "color:red;";
            else if (porc >= 90) estilo = "color:green;";
          } else {
            if (porc > 27.5) estilo = "color:red;";
            else if (porc >= 22.5) estilo = "color:green;";
          }
          
          const row = document.createElement("tr");
          row.classList.add("fila-nutriente");
          row.innerHTML = `
            <td>${n.nombre}</td>
            <td>${formatoNumeroInteligente(val)}</td>
            <td>${n.unidad}</td>
            <td style="${estilo}">${porc.toFixed(1)}%</td>
          `;
          tabla.appendChild(row);
        }
      });
    }
    
    // üéØ Gr√°fico tipo dona
    const canvas = document.getElementById(`grafico-${comida}`);
    if (canvas) {
      const ctx = canvas.getContext("2d");
      const labels = ["Energ√≠a", "Prote√≠nas", "Carbohidratos", "Grasas totales"];
      const datos = labels.map(n => {
        const val = totales[n];
        return vdr[n] ? (val / vdr[n]) * 100 : 0;
      });
      
      if (graficos[comida]) graficos[comida].destroy();
      graficos[comida] = new Chart(ctx, {
        type: "doughnut",
        data: {
          labels,
          datasets: [{
            data: datos,
            backgroundColor: ["#4CAF50", "#FFEB3B", "#F44336", "#00BCD4"]
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: "bottom", labels: { color: "#000" } },
            tooltip: {
              callbacks: {
                label: context => `${context.label}: ${context.raw.toFixed(1)}% VDR`
              }
            }
          }
        }
      });
    }
  });

  comidas.forEach(comida => {
    const seccion = document.querySelector(`#seccion-${comida}`);
    if (seccion) {
      let btn = seccion.querySelector(".btn-toggle-nutrientes");
      
      if (!btn) {
        btn = document.createElement("button");
        btn.className = "btn-toggle-nutrientes";
        btn.style.cssText = `
          margin: 12px 0;
          display: block;
          background: #f3f4f6;
          border: 1px solid #ccc;
          padding: 8px 16px;
          border-radius: 6px;
          cursor: pointer;
          font-size: 14px;
        `;
        btn.addEventListener("click", () => {
          mostrarTodosLosNutrientes = !mostrarTodosLosNutrientes;
          Calculadora(); // Redibuja todo
        });
        
        const tablaCanvas = seccion.querySelector("section") || seccion.querySelector("table");
        if (tablaCanvas) {
          seccion.insertBefore(btn, tablaCanvas);
        } else {
          seccion.appendChild(btn);
        }
      }
      
      btn.textContent = mostrarTodosLosNutrientes ?
        "Ocultar nutrientes irrelevantes" :
        "Mostrar todos los nutrientes";
    }
  });
  
  // ‚úÖ Actualiza perfiles funcionales si ya fueron renderizados
  if (document.getElementById("contenido-perfiles")?.dataset?.inicializado) {
    renderizarPerfilesFuncionales();
  }
}

  function toggleMostrarNutrientes() {
    mostrarTodosLosNutrientes = !mostrarTodosLosNutrientes;
    Calculadora();
  }

function crearToastCopiado(comida) {
  const id = `toast-overlay-${comida}`;
  if (document.getElementById(id)) return;
  
  const overlay = document.createElement("div");
  overlay.id = id;
  overlay.className = "toast-overlay";
  
  // Nuevo estilo: ocupa todo el alto scrolleable de la p√°gina
  const scrollHeight = Math.max(
    document.body.scrollHeight,
    document.documentElement.scrollHeight
  );
  
  overlay.style.cssText = `
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: ${scrollHeight}px;
    background-color: rgba(0, 0, 0, 0.8);
    z-index: 10000;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
  `;
  
  const toast = document.createElement("div");
  toast.className = "toast-copiar";
  toast.textContent = `‚úÖ Resultados de ${comida} copiados al portapapeles`;
  toast.style.cssText = `
    background: #4caf50;
    color: white;
    padding: 12px 20px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 500;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    text-align: center;
    max-width: 90%;
    white-space: pre-line;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    opacity: 0;
    transition: opacity 0.3s ease, transform 0.3s ease;
  `;
  
  overlay.appendChild(toast);
  document.body.appendChild(overlay);
  
  // Mostrar con animaci√≥n
  requestAnimationFrame(() => {
    overlay.style.opacity = "1";
    overlay.style.pointerEvents = "auto";
    toast.style.opacity = "1";
    toast.style.transform = "translate(-50%, -50%)";
  });
  
  // Ocultar
  setTimeout(() => {
    toast.style.opacity = "0";
    toast.style.transform = "translate(-50%, -40%)";
    overlay.style.opacity = "0";
    overlay.style.pointerEvents = "none";
    
    setTimeout(() => {
      overlay.remove();
    }, 300);
  }, 1000);
}

async function compartirResultados(comida) {
  const tabla = document.getElementById(`tabla-${comida}`);
  if (!tabla) return;
  
  const lista = datosComidas[comida] || [];
  
  let texto = `üìå Hace un an√°lisis exhaustivo y riguroso y determina si los datos son correctos con ‚úîÔ∏è y ‚ùå. Sin tablas.\n\n`;
  texto += `üë©‚Äçüç≥ Resultados de ${comida.toUpperCase()}\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n\n`;
  
  // Solo incluir alimentos si NO es "total"
  if (comida !== "total" && lista.length > 0) {
    texto += `ü•ó Alimentos agregados:\n`;
    lista.forEach(({ alimento, peso }) => {
      if (alimento.esManual) {
        const info = alimento.unidadesPersonalizadas?.[alimento.nombre];
        const unidad = info?.unidad || "";
        const valor = info?.valor ?? alimento.composicion[alimento.nombre];
        texto += `‚Ä¢ ${alimento.nombre} (manual): ${valor} ${unidad}\n`;
      } else {
        texto += `‚Ä¢ ${alimento.nombre} ‚Äî ${peso} g\n`;
      }
    });
    texto += `\n`;
  }
  
  // Nutrientes
  texto += `üìä Nutrientes totales:\n`;
  [...tabla.querySelectorAll("tr")].forEach(tr => {
    const tds = tr.querySelectorAll("td");
    if (tds.length >= 3) {
      const nombre = tds[0].textContent.trim();
      const cantidad = tds[1].textContent.trim(); // üëà se mantiene el formato original
      const unidad = tds[2].textContent.trim();
      texto += `‚Ä¢ ${nombre}: ${cantidad} ${unidad}\n`;
    }
  });
  
  texto += `\n‚úÖ Valores calculados autom√°ticamente\nüìé Compartido desde la Calculadora Nutricional`;
  
  try {
    await navigator.clipboard.writeText(texto);
    crearToastCopiado(comida);
  } catch {
    copiarTextoFallback(texto);
  }
}
</script>
<script>
const perfilesFuncionales = {
  "Perfil Tiroideo": [
    "Iodine (I)", "Selenium (Se)", "Zinc (Zn)", "Tyrosine",
    "Vitamin A", "Riboflavin", "Vitamin B-12"
  ],
  "Perfil Inflamatorio": [
    "Vitamin C, total ascorbic acid", "Vitamin E", "Vitamin D",
    "PUFA 20:5 n-3 (EPA)", "PUFA 22:6 n-3 (DHA)",
    "Polyphenols, total", "Flavonols, total", "Flavones, total",
    "Flavanones, total", "Flavans, total", "Catechins, total", "Procyanidins, total", "Anthocyanidins, total"
  ],
  "Perfil Gluc√©mico": [
    "Carbohidratos", "Total Sugars", "Fiber, total dietary",
    "Resistant starch", "Fiber, soluble", "Fiber, insoluble"
  ],
  "Perfil Hormonal y Neurotransmisores": [
    "Tryptophan", "Tyrosine", "Phenylalanine", "Vitamin B-6",
    "Vitamin B-12", "Folate, total", "Choline", "Inositol"
  ],
  "Perfil Lip√≠dico": [
    "Fatty acids, total saturated", "Fatty acids, total monounsaturated",
    "Fatty acids, total polyunsaturated", "PUFA 20:5 n-3 (EPA)",
    "PUFA 22:6 n-3 (DHA)", "Cholesterol"
  ],
  "Perfil Neurol√≥gico": [
    "Vitamin B-12", "Folate, total", "PUFA 22:6 n-3 (DHA)", "Choline", "Iron (Fe)",
    "Vitamin D", "Lutein + zeaxanthin", "Vitamin C, total ascorbic acid"
  ],
  "√çndice de Saciedad": [
    "Prote√≠nas", "Fiber, total dietary", "Fiber, soluble",
    "Resistant starch", "Water"
  ],
  "√çndice de Carga Hep√°tica": [
    "Fructose", "Alcohol, ethyl", "Fatty acids, total trans",
    "Cadmium (Cd)", "Lead (Pb)", "Choline", "Methionine"
  ],
  "√çndice Metab√≥lico General": [
    "Energ√≠a", "Prote√≠nas", "Carbohidratos", "Grasas totales",
    "Thiamin", "Riboflavin", "Niacin", "Pantothenic acid", "Vitamin B-6", "Biotin",
    "Folate, total", "Vitamin B-12", "Magnesium (Mg)", "Iron (Fe)"
  ],
  "√çndice de Densidad Nutricional (NDI)": [
    "Thiamin", "Riboflavin", "Niacin", "Pantothenic acid", "Vitamin B-6", "Biotin",
    "Folate, total", "Vitamin B-12", "Vitamin A", "Vitamin D", "Vitamin E", "Vitamin K (phylloquinone)",
    "Calcium (Ca)", "Phosphorus (P)", "Magnesium (Mg)", "Potassium (K)", "Sodium (Na)", "Chlorine (Cl)", "Sulfur (S)",
    "Iron (Fe)", "Zinc (Zn)", "Copper (Cu)", "Selenium (Se)", "Manganese (Mn)", "Iodine (I)", "Molybdenum (Mo)", "Chromium (Cr)",
    "Fiber, total dietary", "Polyphenols, total"
  ],
  "Prebi√≥ticos y microbiota": [
    "Inulin", "Fructooligosac√°ridos", "GOS", "Resistant starch",
    "Pectin", "Beta-glucan", "Fiber, soluble", "Fiber, total dietary"
  ],
  "Interacciones nutriente-nutriente": [
    "Iron (Fe)", "Vitamin C, total ascorbic acid", "Calcium (Ca)",
    "Magnesium (Mg)", "Zinc (Zn)", "Copper (Cu)", "Folate, total",
    "Vitamin B-12", "Phytic acid", "Tannic acid"
  ],
  "Biodisponibilidad": [
    "Phytic acid", "Tannic acid", "Oxalates", "Lectins, saponins",
    "Fiber, insoluble", "Vitamin C, total ascorbic acid",
    "Fatty acids, total polyunsaturated"
  ],
  "√Åcidos Grasos de Cadena Corta (SCFA)": [
    "Acetic acid", "Butyric acid", "Propionic acid",
    "Fiber, soluble", "Inulin", "Resistant starch"
  ],
  "Bacterias Funcionales": [
    "Lactobacillus spp.", "Bifidobacterium spp."
  ],
  "Calidad Biol√≥gica Proteica": [
    "PDCAAS", "DIAAS", "Amino acid score", "Limiting amino acid report"
  ],
  "Producci√≥n de SCFA estimada": [
    "Inulin", "Fructooligosac√°ridos", "Resistant starch",
    "Beta-glucan", "Pectin", "Cellulose"
  ],
  "Neuroprotectores Funcionales": [
    "Polyphenols, total", "Lutein + zeaxanthin", "PUFA 22:6 n-3 (DHA)", "Vitamin E",
    "Vitamin C, total ascorbic acid", "Curcumin", "Resveratrol"
  ],
  "Carga Renal": [
    "Prote√≠nas", "Phosphorus (P)", "Potassium (K)", "Sodium (Na)",
    "Calcium (Ca)", "Creatinine"
  ],
  "Balance Oxidativo": [
    "Polyphenols, total", "Vitamin C, total ascorbic acid", "Vitamin E",
    "Zinc (Zn)", "Selenium (Se)", "Fatty acids, total polyunsaturated",
    "Iron (Fe)", "Copper (Cu)"
  ],
  "Capacidad Antioxidante (ORAC estimada)": [
    "Anthocyanidins, total", "Catechins, total", "Flavonols, total",
    "Lutein + zeaxanthin", "Vitamin C, total ascorbic acid",
    "Vitamin E", "Polyphenols, total"
  ],
  "Perfil de salud mitocondrial": [
    "Coenzyme Q10", "Lipoic acid", "Carnitine", "Magnesium (Mg)",
    "Vitamin B-1", "Vitamin B-2", "Vitamin B-3", "Vitamin B-6",
    "Vitamin B-12", "Folate, total", "Iron (Fe)", "Copper (Cu)"
  ],
  "Perfil epigen√©tico": [
    "Folate, total", "Vitamin B-12", "Choline", "Betaine",
    "Vitamin B-6", "Zinc (Zn)", "Magnesium (Mg)", "Polyphenols, total"
  ],
  "Perfil inmunol√≥gico": [
    "Vitamin C, total ascorbic acid", "Vitamin D", "Zinc (Zn)", "Selenium (Se)",
    "Iron (Fe)", "Vitamin A", "Vitamin E", "Omega-3 (EPA + DHA)",
    "Glutamine", "Probiotics", "Polyphenols, total"
  ],
  "Perfil de permeabilidad intestinal": [
    "Glutamine", "Zinc (Zn)", "Vitamin A", "Vitamin D",
    "Short-chain fatty acids (SCFA)", "Butyric acid", "Fiber, soluble",
    "Probiotics", "Lactobacillus spp.", "Bifidobacterium spp."
  ],
  "√çndice inflamatorio de la dieta": [
    "Vitamin C, total ascorbic acid", "Vitamin D", "Vitamin E",
    "Omega-3 (EPA + DHA)", "Fiber, total dietary", "Magnesium (Mg)",
    "Saturated fats", "Trans fats", "PUFA 20:4 n-6 (Arachidonic acid)",
    "Polyphenols, total", "Flavonoids, total"
  ],
  "Perfil de metilaci√≥n": [
    "Folate, total", "Vitamin B-12", "Vitamin B-6", "Choline",
    "Betaine", "Methionine", "Zinc (Zn)", "Magnesium (Mg)"
  ],
  "√çndice de calidad de grasa": [
    "Fatty acids, total saturated", "Fatty acids, total monounsaturated",
    "Fatty acids, total polyunsaturated", "PUFA 20:5 n-3 (EPA)",
    "PUFA 22:6 n-3 (DHA)", "Trans fats", "Omega-6/Omega-3 ratio"
  ],
  "√çndice de calidad diet√©tica": [
    "Fruits, total", "Vegetables, total", "Whole grains",
    "Fiber, total dietary", "Sodium (Na)", "Saturated fats",
    "Added sugars", "Protein quality", "Polyphenols, total"
  ],
  "Perfil de detoxificaci√≥n hep√°tica": [
    "Glutathione", "N-acetylcysteine (NAC)", "Sulforaphane", "Vitamin C, total ascorbic acid",
    "Vitamin B-6", "Vitamin B-12", "Folate, total", "Magnesium (Mg)",
    "Glycine", "Methionine", "Glutamine", "Selenium (Se)"
  ],
  "√çndice de carga t√≥xica": [
    "Cadmium (Cd)", "Lead (Pb)", "Mercury (Hg)", "Arsenic (As)",
    "BPA", "Phthalates", "Pesticide residues", "Alcohol, ethyl",
    "Trans fats", "Acrylamide"
  ],
  "Perfil mineral": [
    "Calcium (Ca)", "Magnesium (Mg)", "Phosphorus (P)", "Potassium (K)",
    "Sodium (Na)", "Iron (Fe)", "Zinc (Zn)", "Copper (Cu)", "Selenium (Se)",
    "Iodine (I)", "Manganese (Mn)", "Chromium (Cr)", "Molybdenum (Mo)"
  ]
};

function renderizarPerfilesFuncionales() {
  const contenedor = document.getElementById("contenido-perfiles");
  
  // Solo renderizamos la estructura una vez
  if (!contenedor.dataset.inicializado) {
    contenedor.innerHTML = "";
    
    Object.entries(perfilesFuncionales).forEach(([perfil, nutrientes]) => {
      const section = document.createElement("div");
      section.className = "section perfil-funcional";
      section.dataset.perfil = perfil;
      
      section.innerHTML = `
        <section>
          <h3 class="font-semibold mb-2 text-base">${perfil}</h3>
          <table class="tabla">
            <thead>
              <tr>
                <th>Nutriente</th>
                <th>Cantidad</th>
                <th>Unidad</th>
                <th>VDR%</th>
              </tr>
            </thead>
            <tbody>
              ${nutrientes.map(nutriente => `
                <tr data-nutriente="${nutriente}">
                  <td>${nutriente}</td>
                  <td class="cantidad"></td>
                  <td class="unidad"></td>
                  <td class="vdr"></td>
                </tr>
              `).join("")}
            </tbody>
          </table>
        </section>
      `;
      
      contenedor.appendChild(section);
    });
    
    contenedor.dataset.inicializado = "true";
  }
  
  // Siempre actualizamos los valores
  const totales = {};
  nutrientesPlanos.forEach(n => totales[n.nombre] = 0);
  
  datosComidas.total.forEach(({ alimento, peso }) => {
    nutrientesPlanos.forEach(n => {
      totales[n.nombre] += (alimento.composicion[n.nombre] || 0) * peso / 100;
    });
  });
  
  Object.entries(perfilesFuncionales).forEach(([perfil, nutrientes]) => {
    nutrientes.forEach(nutriente => {
      const cantidad = totales[nutriente] || 0;
      const v = vdr[nutriente] || 0;
      const porc = v ? ((cantidad / v) * 100) : 0;
      const nInfo = nutrientesPlanos.find(n => n.nombre === nutriente);
      const unidad = nInfo?.unidad || "";
      
      const tr = contenedor.querySelector(`.perfil-funcional[data-perfil="${perfil}"] tr[data-nutriente="${nutriente}"]`);
      if (tr) {
        tr.querySelector(".cantidad").textContent = formatoNumeroInteligente(cantidad);
        tr.querySelector(".unidad").textContent = unidad;
        const celdaVDR = tr.querySelector(".vdr");
        celdaVDR.textContent = `${porc.toFixed(1)}%`;
        celdaVDR.style.color = porc > 110 ? 'red' : porc >= 90 ? 'green' : '';
      }
    });
  });
}
</script>
</body>
</html>
